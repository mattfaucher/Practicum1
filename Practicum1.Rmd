---
title: "Practicum1"
author: "Matt Faucher, Kaelyn Jefferson"
date: "10/19/2021"
output: html_document
---
## Connect to the Database
```{r}
# 1. Library
library(RMySQL)
library(DBI)
# 2. Settings
db_user <- 'root'
db_password <- 'root'
db_name <- 'data'
db_host <- 'localhost'
db_port <- 3306
# 3. Read data from db
con <- dbConnect(MySQL(), user = db_user, password = db_password,
                 dbname = db_name, host = db_host, port = db_port)
```
## Create Incidents Table
```{sql connection=con}
CREATE TABLE IF NOT EXISTS incidents (
  iid INTEGER NOT NULL,
  date DATE NOT NULL,
  depPort VARCHAR(255) NOT NULL DEFAULT 'unknown',
  arrPort VARCHAR(255) NOT NULL DEFAULT 'unknown',
  airline VARCHAR(255) NOT NULL DEFAULT 'unknown',
  aircraft VARCHAR(255) NOT NULL,
  flightPhase VARCHAR(255) NOT NULL,
  impact VARCHAR(255) NOT NULL DEFAULT 'none',
  PRIMARY KEY (iid)
);
```
## Create Lookup table for Airlines
```{sql connection=con}
CREATE TABLE IF NOT EXISTS airlines (
  aid INTEGER NOT NULL UNIQUE AUTO_INCREMENT,
  code INTEGER NOT NULL UNIQUE,
  airline VARCHAR(255) NOT NULL,
  PRIMARY KEY (aid)
);
```
## Create Index on Airline in Airlines
```{sql connection=con}
CREATE INDEX airline_idx
ON airlines(airline(255));
```
## Create Lookup table for Airports
```{sql connection=con}
CREATE TABLE IF NOT EXISTS airports (
  pid INTEGER NOT NULL UNIQUE AUTO_INCREMENT,
  code INTEGER NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  city VARCHAR(255) DEFAULT 'N/A',
  state VARCHAR(255) NOT NULL DEFAULT 'N/A',
  country VARCHAR(255) NOT NULL,
  PRIMARY KEY (pid)
);
```
## Create Index on Code in Airports
```{sql connection=con}
CREATE INDEX code_idx
ON airlines(code);
```
## Add Foreign Key References
```{sql connection=con}
ALTER TABLE incidents
ADD FOREIGN KEY(airline) REFERENCES airlines(airline)
ON DELETE CASCADE;
```

```{sql connection=con}
ALTER TABLE airports
ADD FOREIGN KEY (code) REFERENCES airlines(code)
ON DELETE CASCADE;
```
## Read Data from CSV (load)
```{r}
csvFile <- "BirdStrikesData.csv"
df.raw <- read.csv(file = csvFile, header = T, stringsAsFactors = F)
```
## Create dataframe for incidents table
```{r}
iid <- df.raw$Record.ID
date <- df.raw$FlightDate
depPort <- df.raw$Airport..Name
arrPort <- df.raw$Airport..Name
airline <- df.raw$Aircraft..Airline.Operator
aircraft <- df.raw$Aircraft..Make.Model
flightPhase <- df.raw$When..Phase.of.flight
# Harmonize flight phases
for (i in 1: length(flightPhase)) 
  if (flightPhase[i] == 'Take-off run'){
    flightPhase[i] <- 'takeoff'
  } else if (flightPhase[i] == 'Landing roll'){
    flightPhase[i] <- 'landing'
  } else if (flightPhase[i] %in% c('Climb', 'Descent', 'Approach')){
    flightPhase[i] <- 'inflight'
  } else flightPhase[i] <- 'unknown'

impact <- df.raw$Effect..Indicated.Damage
```
## Place all data into incidents table
```{r}
# Build the data frame
incidents <- data.frame(iid, date, depPort, arrPort, airline, aircraft, flightPhase, impact)
dbWriteTable(con, "incidents", incidents, overwrite = T, row.names = F)
```
## Get all data for airports
```{r}
pid <- c(1:25558)
code <- c(1:25558)
name <- df.raw$Airport..Name
city <- c()
for (i in 1:25558) {
  city[i] <- 'N/A'
}
state <- df.raw$Origin.State
country <- df.raw$Origin.State;
for (i in 1:length(country)) {
  if (country[i] != 'N/A') {
    country[i] <- 'USA'
  } else {
    country[i] <- 'N/A'
  }
}
```
## Build table for airports
```{r}
airports <- data.frame(pid, code, name, city, state, country)
dbWriteTable(con, "airports", airports, overwrite = T, row.names = F)
```
## Create dataframe for airlines table & write table
```{r}
airline <- df.raw$Aircraft..Airline.Operator
# Build the data frame
aid <- c(1:25558)
code <- c(1:25558)
airlines <- data.frame(aid, code, airline)
dbWriteTable(con, "airlines", airlines, overwrite = T, row.names = F)
```
## Place defaults in for empty values in incidents table
```{sql connection=con}
UPDATE incidents
SET depPort = 'unknown', arrPort = 'unknown', airline = 'unknown'
WHERE depPort = '' AND arrPort = '' AND airline = '';
```

```{sql connection=con}
UPDATE airlines
SET airline = 'unknown'
WHERE airline = '';
```

## Disconnect from the Databse
```{r}
dbDisconnect(con)
```